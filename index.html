<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; 
        }
        
        .admin-only { display: none; }
        .admin-only.show { display: block; }

        /* Styles for printing appointment card */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            @page {
                size: A5 portrait;
                margin: 0;
            }
            #print-card {
                width: 150mm;
                height: 210mm;
                padding: 5mm;
                box-sizing: border-box;
                font-family: 'Sarabun', sans-serif;
                border: none; /* Changed from border: 1px solid #ccc */
                display: flex;
                flex-direction: column;
                font-size: 14px; /* Added to control print font size */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h1>
                <p class="text-gray-600">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition duration-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-2"><strong>Demo Accounts:</strong></p>
                <p class="text-xs text-gray-500">üë®‚Äç‚öïÔ∏è ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•: nurse1 / password123</p>
                <p class="text-xs text-gray-500">üë©‚Äçüíº ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: admin1 / admin123</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainSystem" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h1>
                            <p class="text-sm text-gray-600" id="userRole">‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="currentDate"></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-blue-200 rounded-xl p-1 flex justify-center w-fit mx-auto shadow-inner">
                    <nav class="flex items-center gap-x-1">
                        <button onclick="showTab('search')" id="searchTab" class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-lg bg-white text-blue-600 shadow-sm">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</button>
                        <button onclick="showTab('register')" id="registerTab" class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-lg text-gray-600 hover:bg-white hover:text-blue-600">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="showTab('appointment')" id="appointmentTab" class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-lg text-gray-600 hover:bg-white hover:text-blue-600 admin-only">üìÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                        <button onclick="showTab('dashboard')" id="dashboardTab" class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-lg text-gray-600 hover:bg-white hover:text-blue-600 admin-only">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Search Patient Tab -->
            <div id="searchContent" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                        <div class="flex space-x-4">
                            <input type="text" id="searchId" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13">
                            <button onclick="searchPatient()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </div>
                    </div>
                    <div id="patientInfo" class="hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</p>
                                    <p class="font-medium" id="patientName"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                                    <p class="font-medium" id="patientPhone"></p>
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <h4 class="font-semibold text-gray-800 mb-2">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h4>
                                    <div id="appointmentTableContainer">
                                        <!-- Appointment table will be generated here -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <h4 class="font-semibold text-gray-800 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h4>
                                <div class="space-y-2" id="vaccineHistory">
                                    <!-- Vaccine history will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointment Registration Tab -->
            <div id="appointmentContent" class="tab-content hidden">
                 <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</h2>
                    <form id="appointmentForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="appointmentNationalId" class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="1234567890123" maxlength="13">
                                    <button type="button" onclick="lookupPatientForAppointment()" class="bg-indigo-500 text-white px-4 rounded-lg hover:bg-indigo-600 transition-colors">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="appointmentPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="081-234-5678">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                                <input type="text" id="appointmentFirstName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input type="text" id="appointmentLastName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</label>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div id="multiDateCalendar" class="max-w-md mx-auto bg-white rounded-lg shadow-sm border">
                                    <!-- Calendar will be generated here -->
                                </div>
                                <div class="mt-4 text-center">
                                    <p class="text-sm text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span id="selectedDatesCount">0</span> ‡∏ß‡∏±‡∏ô)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
                                <input type="text" id="appointmentVaccine" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</label>
                                <input type="text" id="appointmentDosage" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ï‡πá‡∏°‡πÇ‡∏î‡∏™, 0.5 ml">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏µ‡∏î</label>
                                <input type="text" id="appointmentInjectionSite" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Ç‡∏ô‡∏ã‡πâ‡∏≤‡∏¢">
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <button type="button" onclick="addSelectedDates()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            </button>
                        </div>
                        <div id="appointmentDates" class="space-y-3"></div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition duration-200">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
                            </button>
                            <button type="button" onclick="printCurrentAppointmentCard()" class="w-full bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-600 transition duration-200">
                                ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏ô‡∏±‡∏î
                            </button>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Register Patient Tab -->
            <div id="registerContent" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                    <form id="registerForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                                <input type="text" id="firstName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input type="text" id="lastName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                                <input type="text" id="nationalId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="1234567890123" maxlength="13">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î</label>
                            <select id="hospital" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô">‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡πÇ‡∏Ç‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 03 ‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô">‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡πÇ‡∏Ç‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 03 ‡∏´‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πà‡∏ô</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏î‡∏µ ‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏‡∏à‡∏π‡∏î ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 03 ‡∏ö‡∏≤‡∏á‡∏î‡∏µ">‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏î‡∏µ ‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏‡∏à‡∏π‡∏î ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 03 ‡∏ö‡∏≤‡∏á‡∏î‡∏µ</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏î‡∏µ ‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏Å‡πÅ‡∏ï‡∏£‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 05 ‡∏ö‡∏≤‡∏á‡∏î‡∏µ">‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏î‡∏µ ‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏Å‡πÅ‡∏ï‡∏£‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 05 ‡∏ö‡∏≤‡∏á‡∏î‡∏µ</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏≤‡∏ß‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á">‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏≤‡∏ß‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏•‡∏≠‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 05 ‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á">‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏•‡∏≠‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 05 ‡∏ö‡∏≤‡∏á‡∏Å‡∏∏‡πâ‡∏á</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö ‡∏ö‡πâ‡∏≤‡∏ô‡∏ñ‡∏ô‡∏ô‡πÅ‡∏û‡∏£‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 04 ‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö">‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö ‡∏ö‡πâ‡∏≤‡∏ô‡∏ñ‡∏ô‡∏ô‡πÅ‡∏û‡∏£‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 04 ‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 08 ‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö">‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 08 ‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≠‡∏ö</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Ç‡∏≤‡∏ß ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏ô‡∏ó‡∏±‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 07 ‡πÄ‡∏Ç‡∏≤‡∏Ç‡∏≤‡∏ß">‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Ç‡∏≤‡∏ß ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏ô‡∏ó‡∏±‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 07 ‡πÄ‡∏Ç‡∏≤‡∏Ç‡∏≤‡∏ß</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏õ‡∏π‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏≤‡∏õ‡∏π‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡πÄ‡∏Ç‡∏≤‡∏õ‡∏π‡∏ô">‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏õ‡∏π‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏≤‡∏õ‡∏π‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡πÄ‡∏Ç‡∏≤‡∏õ‡∏π‡∏ô</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏õ‡∏≤‡∏Å‡πÅ‡∏à‡πà‡∏° ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≠‡∏¢ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 03 ‡∏õ‡∏≤‡∏Å‡πÅ‡∏à‡πà‡∏°">‡∏£‡∏û.‡∏™‡∏ï.‡∏õ‡∏≤‡∏Å‡πÅ‡∏à‡πà‡∏° ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≠‡∏¢ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 03 ‡∏õ‡∏≤‡∏Å‡πÅ‡∏à‡πà‡∏°</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏° ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏î ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏°">‡∏£‡∏û.‡∏™‡∏ï.‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏° ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏î ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏°</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡πà‡∏≤‡∏á‡∏¥‡πâ‡∏ß ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏¥‡∏ô‡∏á‡∏≠‡∏° ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 07 ‡∏ó‡πà‡∏≤‡∏á‡∏¥‡πâ‡∏ß">‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡πà‡∏≤‡∏á‡∏¥‡πâ‡∏ß ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏¥‡∏ô‡∏á‡∏≠‡∏° ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 07 ‡∏ó‡πà‡∏≤‡∏á‡∏¥‡πâ‡∏ß</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏•‡∏≥‡∏†‡∏π‡∏£‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 01 ‡∏•‡∏≥‡∏†‡∏π‡∏£‡∏≤">‡∏£‡∏û.‡∏™‡∏ï.‡∏•‡∏≥‡∏†‡∏π‡∏£‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 01 ‡∏•‡∏≥‡∏†‡∏π‡∏£‡∏≤</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ô‡∏≤‡∏ß‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏°‡∏≠ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 01 ‡∏ô‡∏≤‡∏ß‡∏á">‡∏£‡∏û.‡∏™‡∏ï.‡∏ô‡∏≤‡∏ß‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏°‡∏≠ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 01 ‡∏ô‡∏≤‡∏ß‡∏á</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ô‡∏≤‡∏ß‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏û‡∏ò‡∏¥‡πå‡πÇ‡∏ó‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 06 ‡∏ô‡∏≤‡∏ß‡∏á">‡∏£‡∏û.‡∏™‡∏ï.‡∏ô‡∏≤‡∏ß‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏û‡∏ò‡∏¥‡πå‡πÇ‡∏ó‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 06 ‡∏ô‡∏≤‡∏ß‡∏á</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡∏≤‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡∏≤‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡∏≤‡∏á">‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡∏≤‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡∏≤‡∏á ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02 ‡∏´‡πâ‡∏ß‡∏¢‡∏ô‡∏≤‡∏á</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡πÉ‡∏ô‡πÄ‡∏ï‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏±‡∏î ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 01 ‡πÉ‡∏ô‡πÄ‡∏ï‡∏≤">‡∏£‡∏û.‡∏™‡∏ï.‡πÉ‡∏ô‡πÄ‡∏ï‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏±‡∏î ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 01 ‡πÉ‡∏ô‡πÄ‡∏ï‡∏≤</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡∏∏‡πà‡∏á‡∏ï‡πà‡∏≠ ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡∏•‡∏∂‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 07 ‡∏ó‡∏∏‡πà‡∏á‡∏ï‡πà‡∏≠">‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡∏∏‡πà‡∏á‡∏ï‡πà‡∏≠ ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡πâ‡∏ß‡∏¢‡∏•‡∏∂‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 07 ‡∏ó‡∏∏‡πà‡∏á‡∏ï‡πà‡∏≠</option>
                                <option value="‡∏£‡∏û.‡∏™‡∏ï.‡∏ß‡∏±‡∏á‡∏Ñ‡∏µ‡∏£‡∏µ ‡∏ö‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏•‡∏≥‡πÉ‡∏ï‡πâ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02">‡∏£‡∏û.‡∏™‡∏ï.‡∏ß‡∏±‡∏á‡∏Ñ‡∏µ‡∏£‡∏µ ‡∏ö‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏•‡∏≥‡πÉ‡∏ï‡πâ ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 02</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î</label>
                                <input type="date" id="vaccineDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
                                <input type="text" id="vaccineName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</label>
                                <input type="text" id="vaccineDosage" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ï‡πá‡∏°‡πÇ‡∏î‡∏™">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏µ‡∏î</label>
                                <input type="text" id="injectionSite" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Ç‡∏ô‡∏ã‡πâ‡∏≤‡∏¢">
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <button type="button" onclick="addVaccineDate()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î
                            </button>
                        </div>
                        <div id="vaccineDates" class="space-y-3"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition duration-200">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </form>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <!-- ***** MODIFIED SECTION START ***** -->
            <div id="dashboardContent" class="tab-content hidden">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                        <div class="space-y-4" id="todayAppointments">
                            <!-- Today's appointments will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- ***** MODIFIED SECTION END ***** -->

        </main>
    </div>
    
    <!-- Container for printing -->
    <div id="print-container" class="hidden"></div>

    <script>
        // =================================================================
        // SCRIPT CONFIGURATION
        // =================================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJvCAlvkVLww51VntYTbMDoNzbxfVUxxLfKcknVAG202mtrYVE8Wq9oIhF-8aBVzWM/exec';
        let currentUserRole = '';
        let vaccineDatesArray = [];
        let appointmentDatesArray = [];
        let selectedDates = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const loggedInUserRole = sessionStorage.getItem('userRole');
            if (loggedInUserRole) {
                console.log('‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô session:', loggedInUserRole);
                showMainSystem(loggedInUserRole);
            }
            updateCurrentDate();
            generateCalendar();
        });

        function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('th-TH', options);
        }

        // =================================================================
        // AUTHENTICATION & UI MANAGEMENT
        // =================================================================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginButton = this.querySelector('button[type="submit"]');
            const originalButtonText = loginButton.textContent;

            loginButton.disabled = true;
            loginButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'login', username, password })
                });
                const result = await response.json();
                if (result.success) {
                    sessionStorage.setItem('userRole', result.role);
                    showMainSystem(result.role);
                } else {
                    alert('‚ùå ' + (result.message || result.error || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'));
                }
            } catch (error) {
                console.error('Login Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = originalButtonText;
            }
        });

        function showMainSystem(role) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            currentUserRole = role;
            document.getElementById('userRole').textContent = role;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('show'));
            if (role === '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show'));
            }
            showTab('search');
        }

        function logout() {
            sessionStorage.removeItem('userRole');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('loginForm').reset();
            currentUserRole = '';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                tab.classList.add('text-gray-600');
            });
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('text-gray-600');
            activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            if (tabName === 'dashboard') {
                loadDashboardData();
            }
        }
        
        // =================================================================
        // DASHBOARD FUNCTIONS
        // =================================================================
        async function loadDashboardData() {
            const container = document.getElementById('todayAppointments');
            container.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢...</p>';
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'getTodaysAppointments' })
                });
                const result = await response.json();
                if (result.success && result.data) {
                    container.innerHTML = '';
                    if (result.data.length > 0) {
                        result.data.forEach(app => {
                            const statusColor = app.status === '‡∏â‡∏µ‡∏î‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                            const appointmentCard = document.createElement('div');
                            appointmentCard.className = 'flex justify-between items-center p-4 bg-blue-50 rounded-lg border border-blue-200';
                            appointmentCard.innerHTML = `
                                <div>
                                    <p class="font-medium text-blue-800">${app.name}</p>
                                    <p class="text-sm text-blue-600">${app.phone || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'}</p>
                                    <p class="text-sm text-gray-600">${app.vaccine}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block px-2 py-1 text-xs rounded-full ${statusColor}">${app.status}</span>
                                </div>`;
                            container.appendChild(appointmentCard);
                        });
                    } else {
                        container.innerHTML = '<p class="text-center text-gray-500">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>';
                    }
                } else {
                    throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Dashboard Load Error:', error);
                container.innerHTML = `<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            }
        }

        // =================================================================
        // PATIENT SEARCH FUNCTIONS
        // =================================================================
        async function searchPatient() {
            const searchId = document.getElementById('searchId').value.trim();
            if (!searchId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô');
                return;
            }
            const searchButton = document.querySelector('#searchContent button');
            const originalText = searchButton.textContent;
            searchButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            searchButton.disabled = true;
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'searchPatient', nationalId: searchId })
                });
                const result = await response.json();
                if (result.success) {
                    displayPatientInfo(result.data);
                } else {
                    alert('‚ùå ' + (result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'));
                    document.getElementById('patientInfo').classList.add('hidden');
                }
            } catch (error) {
                console.error('Search Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
            } finally {
                searchButton.textContent = originalText;
                searchButton.disabled = false;
            }
        }

        function displayPatientInfo(patientData) {
            document.getElementById('patientName').textContent = patientData.name;
            document.getElementById('patientPhone').textContent = patientData.phone || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            const appointmentContainer = document.getElementById('appointmentTableContainer');
            appointmentContainer.innerHTML = '';
            const vaccinationDates = new Set((patientData.history || []).map(record => record.date));

            if (patientData.appointments && patientData.appointments.length > 0) {
                let tableHtml = `
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î (‡∏û.‡∏®.)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏µ‡∏î</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">`;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                patientData.appointments.forEach(app => {
                    const appDate = new Date(app.date);
                    let statusText = '';
                    let statusColorClass = '';
                    if (vaccinationDates.has(app.date)) {
                        statusText = '‡∏â‡∏µ‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                        statusColorClass = 'bg-green-100 text-green-800';
                    } else if (appDate < today) {
                        statusText = '‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î';
                        statusColorClass = 'bg-red-100 text-red-800';
                    } else {
                        statusText = '‡∏£‡∏≠‡∏â‡∏µ‡∏î';
                        statusColorClass = 'bg-gray-100 text-gray-800';
                    }
                    tableHtml += `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${formatThaiDate(app.date)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${app.vaccine}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${app.dosage || '-'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${app.injectionSite || '-'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">${statusText}</span>
                            </td>
                        </tr>`;
                });
                tableHtml += `</tbody></table></div>`;
                appointmentContainer.innerHTML = tableHtml;
            } else {
                appointmentContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>';
            }

            const historyContainer = document.getElementById('vaccineHistory');
            historyContainer.innerHTML = '';
            if (patientData.history && patientData.history.length > 0) {
                patientData.history.forEach(record => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    historyItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${record.vaccineName || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${record.hospital || 'N/A'}</p>
                        </div>
                        <span class="text-sm text-gray-500">${formatThaiDate(record.date)}</span>`;
                    historyContainer.appendChild(historyItem);
                });
            } else {
                historyContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</p>';
            }
            document.getElementById('patientInfo').classList.remove('hidden');
        }

        // =================================================================
        // DATA REGISTRATION & APPOINTMENT FUNCTIONS
        // =================================================================
        
        async function lookupPatientForAppointment() {
            const nationalId = document.getElementById('appointmentNationalId').value.trim();
            if (!nationalId) {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
            }

            const lookupButton = document.querySelector('#appointmentContent button[onclick="lookupPatientForAppointment()"]');
            const originalButtonText = lookupButton.textContent;
            lookupButton.textContent = '...';
            lookupButton.disabled = true;

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'searchPatient', nationalId: nationalId })
                });
                const result = await response.json();

                if (result.success && result.data) {
                    const patient = result.data;
                    const nameParts = patient.name.split(' ');
                    document.getElementById('appointmentFirstName').value = nameParts[0] || '';
                    document.getElementById('appointmentLastName').value = nameParts.slice(1).join(' ') || '';
                    document.getElementById('appointmentPhone').value = patient.phone || '';

                    appointmentDatesArray = patient.appointments || [];
                    updateAppointmentDatesDisplay();
                    alert('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    document.getElementById('appointmentFirstName').value = '';
                    document.getElementById('appointmentLastName').value = '';
                    document.getElementById('appointmentPhone').value = '';
                    appointmentDatesArray = [];
                    updateAppointmentDatesDisplay();
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
                }
            } catch (error) {
                console.error('Lookup Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } finally {
                lookupButton.textContent = originalButtonText;
                lookupButton.disabled = false;
            }
        }

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                nationalId: document.getElementById('nationalId').value.trim(),
                hospital: document.getElementById('hospital').value,
                vaccineDates: vaccineDatesArray
            };
            if (!formData.firstName || !formData.lastName || !formData.nationalId || !formData.hospital) {
                return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            }
            if (vaccineDatesArray.length === 0) {
                return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
            savePatientToGoogleSheets(formData);
        });

        async function savePatientToGoogleSheets(formData) {
            const submitButton = document.querySelector('#registerForm button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            submitButton.disabled = true;
            try {
                const vaccineRecords = formData.vaccineDates.map(vaccine => ({
                    timestamp: new Date().toLocaleString('th-TH'),
                    nationalId: formData.nationalId,
                    firstName: formData.firstName,
                    lastName: formData.lastName,
                    phone: '', // Send empty string for phone
                    hospital: formData.hospital,
                    vaccineDate: formatThaiDate(vaccine.date),
                    vaccineName: vaccine.vaccine,
                    dosage: vaccine.dosage, 
                    injectionSite: vaccine.site,
                    status: '‡∏â‡∏µ‡∏î‡πÅ‡∏•‡πâ‡∏ß',
                    createdBy: currentUserRole
                }));
                for (const record of vaccineRecords) {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'savePatient', data: record })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                }
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
                document.getElementById('registerForm').reset();
                vaccineDatesArray = [];
                updateVaccineDatesDisplay();
            } catch (error) {
                console.error('Error saving patient:', error);
                alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }
        
        document.getElementById('appointmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = {
                nationalId: document.getElementById('appointmentNationalId').value,
                phone: document.getElementById('appointmentPhone').value,
                firstName: document.getElementById('appointmentFirstName').value,
                lastName: document.getElementById('appointmentLastName').value,
                appointments: appointmentDatesArray
            };
             if (!formData.firstName || !formData.lastName || !formData.phone || !formData.nationalId) {
                return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            }
            if (appointmentDatesArray.length === 0) {
                return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
            saveAppointmentToGoogleSheets(formData);
        });

        async function saveAppointmentToGoogleSheets(formData) {
            const submitButton = document.querySelector('#appointmentForm button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            submitButton.disabled = true;
            try {
                const appointments = formData.appointments.map(appointment => ({
                    timestamp: new Date().toLocaleString('th-TH'),
                    nationalId: formData.nationalId,
                    firstName: formData.firstName,
                    lastName: formData.lastName,
                    phone: formData.phone,
                    appointmentDate: formatThaiDate(appointment.date),
                    vaccine: appointment.vaccine,
                    dosage: appointment.dosage, 
                    injectionSite: appointment.injectionSite, 
                    status: '‡∏£‡∏≠‡∏ô‡∏±‡∏î',
                    createdBy: currentUserRole
                }));
                for (const appointment of appointments) {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'saveAppointment', data: appointment })
                    });
                }
                
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
                printCurrentAppointmentCard(); 

                document.getElementById('appointmentForm').reset();
                appointmentDatesArray = [];
                updateAppointmentDatesDisplay();
            } catch (error) {
                console.error('Error saving appointment:', error);
                alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        // =================================================================
        // HELPER & UTILITY FUNCTIONS
        // =================================================================
        
        function printCurrentAppointmentCard() {
            const formData = {
                nationalId: document.getElementById('appointmentNationalId').value,
                phone: document.getElementById('appointmentPhone').value,
                firstName: document.getElementById('appointmentFirstName').value,
                lastName: document.getElementById('appointmentLastName').value,
                appointments: appointmentDatesArray
            };

            if (!formData.firstName || !formData.lastName || !formData.nationalId || formData.appointments.length === 0) {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
            }
            printAppointmentCard(formData);
        }

                // ***** MODIFIED FUNCTION START *****
        // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                // ***** MODIFIED FUNCTION START *****
        // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                // ***** MODIFIED FUNCTION START *****
        // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function printAppointmentCard(formData) {
            const printContainer = document.getElementById('print-container');
            
            let appointmentRows = '';
            formData.appointments.forEach(app => {
                appointmentRows += `
                    <tr class="border-b">
                        <td class="py-2 px-4 text-left">${formatThaiDate(app.date)}</td>
                        <td class="py-2 px-4 text-left">${app.vaccine}</td>
                        <td class="py-2 px-4 text-left">${app.dosage || '-'}</td>
                        <td class="py-2 px-4 text-left">${app.injectionSite || '-'}</td>
                        <td class="py-2 px-4 text-left" style="border-bottom: 1px dotted #999;"></td>
                    </tr>
                `;
            });

            const cardHTML = `
                <div id="print-card" class="p-0 bg-white flex flex-col h-full text-gray-800 text-sm">
                    <div class="text-center mb-6">
                        <h1 class="text-xl font-bold">‡πÉ‡∏ö‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h1>
                        <p class="text-base">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ï‡∏≥‡∏ö‡∏•</p>
                    </div>
                    <div class="mb-6">
                        <h2 class="text-base font-semibold border-b pb-2 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                        <div class="space-y-1 text-xs">
                            <div class="flex">
                                <span class="font-medium text-gray-600 w-1/3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
                                <span class="font-bold">${formData.firstName} ${formData.lastName}</span>
                            </div>
                            <div class="flex">
                                <span class="font-medium text-gray-600 w-1/3">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</span>
                                <span class="font-bold">${formData.nationalId}</span>
                            </div>
                            <div class="flex">
                                <span class="font-medium text-gray-600 w-1/3">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span>
                                <span class="font-bold">${formData.phone || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-base font-semibold border-b pb-2 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
                        <table class="w-full text-left border-collapse text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-2 px-4 font-semibold text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î</th>
                                    <th class="py-2 px-4 font-semibold text-left">‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</th>
                                    <th class="py-2 px-4 font-semibold text-left">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</th>
                                    <th class="py-2 px-4 font-semibold text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏µ‡∏î</th>
                                    <th class="py-2 px-4 font-semibold text-left">‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appointmentRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Signature Block -->
                    <div class="mt-auto pt-12 text-right text-xs">
                        <p class="mb-4">....................................................</p>
                        <p>(....................................................)</p>
                        <p>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
                    </div>

                    <div class="pt-4 text-center text-xs text-gray-500">
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÉ‡∏ö‡∏ô‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        <p>‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                </div>
            `;

            printContainer.innerHTML = cardHTML;
            window.print();
        }
        // ***** MODIFIED FUNCTION END *****



        function addVaccineDate() {
            const date = document.getElementById('vaccineDate').value;
            const vaccine = document.getElementById('vaccineName').value;
            const dosage = document.getElementById('vaccineDosage').value;
            const site = document.getElementById('injectionSite').value;
            if (date && vaccine && dosage && site) {
                vaccineDatesArray.push({ date, vaccine, dosage, site });
                updateVaccineDatesDisplay();
                document.getElementById('vaccineDate').value = '';
                document.getElementById('vaccineName').value = '';
                document.getElementById('vaccineDosage').value = '';
                document.getElementById('injectionSite').value = '';
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            }
        }

        function updateVaccineDatesDisplay() {
            const container = document.getElementById('vaccineDates');
            container.innerHTML = '';
            vaccineDatesArray.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-4 p-4 bg-blue-50 rounded-lg border border-blue-200';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-blue-800">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î: ${formatThaiDate(data.date)}</p>
                        <p class="text-sm text-blue-600">‡∏¢‡∏≤: ${data.vaccine} (${data.dosage}, ${data.site})</p>
                    </div>
                    <button onclick="removeVaccineDate(${index})" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600">‡∏•‡∏ö</button>`;
                container.appendChild(div);
            });
        }

        function removeVaccineDate(index) {
            vaccineDatesArray.splice(index, 1);
            updateVaccineDatesDisplay();
        }

        function addSelectedDates() {
            const vaccine = document.getElementById('appointmentVaccine').value;
            const dosage = document.getElementById('appointmentDosage').value;
            const injectionSite = document.getElementById('appointmentInjectionSite').value;

            if (selectedDates.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢');
            if (!vaccine || !dosage || !injectionSite) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏¢‡∏≤, ‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤, ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)');
            
            selectedDates.forEach(date => appointmentDatesArray.push({ date, vaccine, dosage, injectionSite }));
            updateAppointmentDatesDisplay();
            selectedDates = [];
            document.getElementById('appointmentVaccine').value = '';
            document.getElementById('appointmentDosage').value = '';
            document.getElementById('appointmentInjectionSite').value = '';
            generateCalendar();
        }

        function updateAppointmentDatesDisplay() {
            const container = document.getElementById('appointmentDates');
            container.innerHTML = '';
            appointmentDatesArray.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-4 p-4 bg-green-50 rounded-lg border border-green-200';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-green-800">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î: ${formatThaiDate(data.date)}</p>
                        <p class="text-sm text-green-600">‡∏¢‡∏≤: ${data.vaccine} (${data.dosage}, ${data.injectionSite})</p>
                    </div>
                    <button onclick="deleteAppointmentFromSheet(${index})" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600">‡∏•‡∏ö</button>`;
                container.appendChild(div);
            });
        }

        async function deleteAppointmentFromSheet(index) {
            const appointmentToDelete = appointmentDatesArray[index];
            const nationalId = document.getElementById('appointmentNationalId').value;

            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(appointmentToDelete.date)} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }

            const deleteButton = event.target;
            deleteButton.textContent = '...';
            deleteButton.disabled = true;

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'deleteAppointment',
                        nationalId: nationalId,
                        appointmentDate: appointmentToDelete.date 
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    appointmentDatesArray.splice(index, 1);
                    updateAppointmentDatesDisplay();
                } else {
                    throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Delete Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                deleteButton.textContent = '‡∏•‡∏ö';
                deleteButton.disabled = false;
            }
        }


        function generateCalendar() {
            const calendar = document.getElementById('multiDateCalendar');
            const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            let calendarHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button type="button" onclick="previousMonth()" class="p-2 hover:bg-gray-100 rounded-lg">&lt;</button>
                        <h3 class="text-lg font-semibold">${monthNames[currentMonth]} ${currentYear + 543}</h3>
                        <button type="button" onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        ${dayNames.map(day => `<div class="text-center text-sm font-medium text-gray-600 p-2">${day}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1">`;
            for (let i = 0; i < firstDay.getDay(); i++) { calendarHTML += `<div class="p-2"></div>`; }
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day;
                const isSelected = selectedDates.includes(dateStr);
                const isPast = new Date(currentYear, currentMonth, day) < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                let classes = 'p-2 text-center cursor-pointer rounded-lg transition-colors duration-200 ';
                if (isPast) classes += 'text-gray-400 cursor-not-allowed ';
                else if (isSelected) classes += 'bg-blue-600 text-white hover:bg-blue-700 ';
                else if (isToday) classes += 'bg-blue-100 text-blue-600 hover:bg-blue-200 ';
                else classes += 'hover:bg-gray-100 ';
                const onclick = isPast ? '' : `onclick="toggleDate('${dateStr}')"`;
                calendarHTML += `<div class="${classes}" ${onclick}>${day}</div>`;
            }
            calendarHTML += `</div></div>`;
            calendar.innerHTML = calendarHTML;
            updateSelectedDatesCount();
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            generateCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            generateCalendar();
        }

        function toggleDate(dateStr) {
            const index = selectedDates.indexOf(dateStr);
            if (index > -1) selectedDates.splice(index, 1);
            else selectedDates.push(dateStr);
            generateCalendar();
        }

        function updateSelectedDatesCount() {
            document.getElementById('selectedDatesCount').textContent = selectedDates.length;
        }

        function formatThaiDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            const year = date.getFullYear();
            const thaiYear = year > 2500 ? year : year + 543;
            const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${thaiYear}`;
        }
        
        ['appointmentPhone'].forEach(id => {
            document.getElementById(id).addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) value = value.substring(0, 10);
                if (value.length >= 3 && value.length <= 6) value = value.replace(/(\d{3})(\d+)/, '$1-$2');
                else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1-$2-$3');
                e.target.value = value;
            });
        });
        ['nationalId', 'appointmentNationalId', 'searchId'].forEach(id => {
            document.getElementById(id).addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        });

    </script>
</body>
</html>

